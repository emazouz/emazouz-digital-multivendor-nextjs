generator client {
  provider = "prisma-client"
}

datasource db {
  provider = "postgresql"
}

// ========================================
// AUTHENTICATION & USER MANAGEMENT (NextAuth.js)
// ========================================

enum UserRole {
  USER
  ADMIN
  VENDOR
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // Hashed, nullable for OAuth users
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts  Account[]
  sessions  Session[]
  vendor    Vendor?
  reviews   Review[]
  purchases Purchase[]

  @@index([email])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ========================================
// VENDOR SYSTEM
// ========================================

model Vendor {
  id            String   @id @default(cuid())
  userId        String   @unique
  storeName     String
  slug          String   @unique
  about         String?  @db.Text
  totalSales    Int      @default(0)
  avatarUrl     String?
  coverImageUrl String?
  location      String?
  website       String?
  joinedAt      DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  products Product[]

  @@index([slug])
  @@index([userId])
  @@map("vendors")
}

// ========================================
// PRODUCT CORE
// ========================================

enum ProductCategory {
  THEME
  PLUGIN
  GRAPHIC
  JS_MOBILE
  JS_WEB
  PHP
  WORDPRESS
  HTML
  OTHER
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Product {
  id               String          @id @default(cuid())
  vendorId         String
  title            String
  slug             String          @unique
  price            Decimal         @db.Decimal(10, 2)
  currency         String          @default("USD")
  salesCount       Int             @default(0)
  averageRating    Decimal         @default(0) @db.Decimal(3, 2)
  shortDescription String?         @db.Text
  longDescription  String?         @db.Text
  thumbnailUrl     String?
  
  // Technical Specifications
  isHighResolution Boolean         @default(false)
  isWidgetReady    Boolean         @default(false)
  layout           String?         // "Responsive", "Fixed", etc.
  fileSize         String?         // "25.3 MB"
  framework        String?         // "Underscores", "Custom", etc.
  
  // Categorization
  category         ProductCategory @default(THEME)
  subcategory      String?
  status           ProductStatus   @default(DRAFT)
  
  // Dates
  publishedAt      DateTime?
  lastUpdate       DateTime        @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // Relations
  vendor                   Vendor                    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  reviews                  Review[]
  productTags              ProductTag[]
  productCompatibles       ProductCompatible[]
  productSoftwareVersions  ProductSoftwareVersion[]
  productBrowsers          ProductBrowser[]
  productFeatures          ProductFeature[]
  productFiles             ProductFile[]
  productImages            ProductImage[]
  purchases                Purchase[]

  @@index([vendorId])
  @@index([slug])
  @@index([category])
  @@index([status])
  @@index([publishedAt])
  @@map("products")
}

model ProductFile {
  id            String   @id @default(cuid())
  productId     String
  fileName      String
  fileUrl       String
  fileType      String   // "zip", "pdf", etc.
  fileSizeBytes BigInt
  version       String?
  uploadedAt    DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_files")
}

model ProductImage {
  id           String   @id @default(cuid())
  productId    String
  imageUrl     String
  displayOrder Int      @default(0)
  isPreview    Boolean  @default(false)
  uploadedAt   DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

// ========================================
// PRODUCT ATTRIBUTES (Many-to-Many)
// ========================================

// Tags (e.g., saas, wordpress, theme)
model Tag {
  id         String   @id @default(cuid())
  name       String   @unique
  slug       String   @unique
  usageCount Int      @default(0)
  createdAt  DateTime @default(now())

  productTags ProductTag[]

  @@index([slug])
  @@map("tags")
}

model ProductTag {
  id        String   @id @default(cuid())
  productId String
  tagId     String
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([productId, tagId])
  @@index([productId])
  @@index([tagId])
  @@map("product_tags")
}

// Compatible With (e.g., Elementor, WooCommerce 6.x)
model Compatible {
  id        String   @id @default(cuid())
  name      String   @unique
  version   String?
  type      String?  // "Page Builder", "Plugin", "Framework"
  createdAt DateTime @default(now())

  productCompatibles ProductCompatible[]

  @@map("compatibles")
}

model ProductCompatible {
  id           String   @id @default(cuid())
  productId    String
  compatibleId String
  createdAt    DateTime @default(now())

  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  compatible Compatible @relation(fields: [compatibleId], references: [id], onDelete: Cascade)

  @@unique([productId, compatibleId])
  @@index([productId])
  @@index([compatibleId])
  @@map("product_compatibles")
}

// Software Versions (e.g., WordPress 6.0, PHP 8.0)
model SoftwareVersion {
  id          String    @id @default(cuid())
  software    String    // "WordPress", "PHP", "MySQL"
  version     String    // "6.0", "8.0"
  releaseDate DateTime?
  createdAt   DateTime  @default(now())

  productSoftwareVersions ProductSoftwareVersion[]

  @@unique([software, version])
  @@map("software_versions")
}

model ProductSoftwareVersion {
  id                String   @id @default(cuid())
  productId         String
  softwareVersionId String
  createdAt         DateTime @default(now())

  product         Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  softwareVersion SoftwareVersion @relation(fields: [softwareVersionId], references: [id], onDelete: Cascade)

  @@unique([productId, softwareVersionId])
  @@index([productId])
  @@index([softwareVersionId])
  @@map("product_software_versions")
}

// Browsers (e.g., Firefox, Chrome, Edge)
model Browser {
  id         String   @id @default(cuid())
  name       String   @unique
  minVersion String?
  createdAt  DateTime @default(now())

  productBrowsers ProductBrowser[]

  @@map("browsers")
}

model ProductBrowser {
  id        String   @id @default(cuid())
  productId String
  browserId String
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  browser Browser @relation(fields: [browserId], references: [id], onDelete: Cascade)

  @@unique([productId, browserId])
  @@index([productId])
  @@index([browserId])
  @@map("product_browsers")
}

// Features (e.g., "One Click Demo Import")
model Feature {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?  @db.Text
  category    String?  // "Performance", "SEO", "UX"
  createdAt   DateTime @default(now())

  productFeatures ProductFeature[]

  @@map("features")
}

model ProductFeature {
  id        String   @id @default(cuid())
  productId String
  featureId String
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  feature Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([productId, featureId])
  @@index([productId])
  @@index([featureId])
  @@map("product_features")
}

// ========================================
// REVIEWS & RATINGS
// ========================================

model Review {
  id                 String   @id @default(cuid())
  userId             String
  productId          String
  rating             Int      // 1 to 5
  comment            String?  @db.Text
  isVerifiedPurchase Boolean  @default(false)
  helpfulCount       Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([rating])
  @@map("reviews")
}

// ========================================
// TRANSACTIONS & PURCHASES
// ========================================

enum PurchaseStatus {
  PENDING
  COMPLETED
  REFUNDED
  FAILED
}

model Purchase {
  id            String         @id @default(cuid())
  userId        String
  productId     String
  amount        Decimal        @db.Decimal(10, 2)
  currency      String         @default("USD")
  status        PurchaseStatus @default(PENDING)
  paymentMethod String?
  transactionId String?        @unique
  purchasedAt   DateTime       @default(now())
  refundedAt    DateTime?
  updatedAt     DateTime       @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([status])
  @@index([purchasedAt])
  @@map("purchases")
}