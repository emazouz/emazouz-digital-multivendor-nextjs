
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}




enum UserRole {
  USER    // مستخدم عادي (مشتري)
  ADMIN   // مدير النظام (صلاحيات كاملة)
  VENDOR  // بائع (يمكنه بيع المنتجات)
}

// ============================
// جدول المستخدمين الرئيسي
// ============================
// يحتوي على كل المعلومات الأساسية للمستخدمين
model User {
  // ====== الحقول الأساسية ======
  id            String    @id @default(cuid())  // معرّف فريد (CUID أكثر أماناً من UUID)
  name          String?                         // اسم المستخدم (اختياري)
  email         String    @unique               // البريد الإلكتروني (فريد لكل مستخدم)
  emailVerified DateTime?                       // تاريخ تأكيد البريد (null إذا لم يتم التأكيد)
  image         String?                         // رابط صورة الملف الشخصي
  password      String?                         // كلمة المرور المشفرة (null للمستخدمين عبر OAuth)
  role          UserRole  @default(USER)        // دور المستخدم (افتراضياً: مستخدم عادي)
  
  // ====== حقول التتبع الزمني ======
  createdAt     DateTime  @default(now())       // تاريخ إنشاء الحساب
  updatedAt     DateTime  @updatedAt            // تاريخ آخر تحديث (يُحدّث تلقائياً)

  // ====== العلاقات مع الجداول الأخرى ======
  accounts  Account[]   // حسابات OAuth المرتبطة (Google, GitHub, etc.)
  sessions  Session[]   // جلسات تسجيل الدخول النشطة
  vendor    Vendor?     // متجر البائع (إذا كان المستخدم بائعاً) - علاقة واحد لواحد
  reviews   Review[]    // التقييمات التي كتبها المستخدم
  purchases Purchase[]  // المشتريات التي قام بها

  // ====== الفهارس لتحسين الأداء ======
  @@index([email])      // فهرس على البريد لتسريع عمليات البحث وتسجيل الدخول
  @@map("users")        // اسم الجدول في قاعدة البيانات
}

// ============================
// جدول الحسابات (OAuth)
// ============================
// يُستخدم لتخزين معلومات تسجيل الدخول عبر مزودي الخدمة الخارجيين
model Account {
  id                String  @id @default(cuid())
  userId            String                          // معرّف المستخدم المالك
  type              String                          // نوع الحساب: "oauth" أو "email"
  provider          String                          // المزود: "google", "github", etc.
  providerAccountId String                          // معرّف الحساب عند المزود
  
  // ====== معلومات OAuth ======
  refresh_token     String? @db.Text                // رمز التحديث (للحصول على access token جديد)
  access_token      String? @db.Text                // رمز الوصول (للتفاعل مع API المزود)
  expires_at        Int?                            // تاريخ انتهاء الرمز (timestamp)
  token_type        String?                         // نوع الرمز: "Bearer" عادةً
  scope             String?                         // الصلاحيات الممنوحة
  id_token          String? @db.Text                // رمز الهوية (OpenID Connect)
  session_state     String?                         // حالة الجلسة

  // ====== العلاقات ======
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  // عند حذف المستخدم، تُحذف كل حساباته تلقائياً

  // ====== القيود والفهارس ======
  @@unique([provider, providerAccountId])  // لا يمكن ربط نفس الحساب مرتين
  @@index([userId])                        // فهرس للبحث السريع بمعرف المستخدم
  @@map("accounts")
}

// ============================
// جدول الجلسات
// ============================
// يُستخدم لتتبع جلسات المستخدمين النشطة
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique            // رمز الجلسة الفريد (يُرسل في الكوكيز)
  userId       String                      // معرّف المستخدم المالك للجلسة
  expires      DateTime                    // تاريخ انتهاء الجلسة

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

// ============================
// جدول رموز التحقق
// ============================
// يُستخدم لتخزين رموز تأكيد البريد الإلكتروني وإعادة تعيين كلمة المرور
model VerificationToken {
  identifier String    // البريد الإلكتروني أو رقم الهاتف
  token      String    @unique  // الرمز الفريد المُرسل للمستخدم
  expires    DateTime  // تاريخ انتهاء صلاحية الرمز

  @@unique([identifier, token])  // كل رمز مرتبط بمعرّف واحد فقط
  @@map("verification_tokens")
}

// ============================================================================
// القسم الثاني: نظام البائعين (Vendors)
// ============================================================================
// يسمح للمستخدمين بإنشاء متاجر خاصة بهم

// ============================
// جدول البائعين
// ============================
model Vendor {
  // ====== المعلومات الأساسية ======
  id            String   @id @default(cuid())
  userId        String   @unique              // معرّف المستخدم (علاقة واحد لواحد)
  storeName     String                        // اسم المتجر
  slug          String   @unique              // معرّف فريد للرابط (e.g., /vendor/colourdev)
  about         String?  @db.Text             // نبذة عن البائع/المتجر
  
  // ====== إحصائيات ومعلومات إضافية ======
  totalSales    Int      @default(0)          // إجمالي عدد المبيعات
  avatarUrl     String?                       // صورة شعار المتجر
  coverImageUrl String?                       // صورة الغلاف
  location      String?                       // الموقع الجغرافي (اختياري)
  website       String?                       // موقع إلكتروني خارجي (اختياري)
  
  // ====== التواريخ ======
  joinedAt      DateTime @default(now())      // تاريخ الانضمام كبائع
  updatedAt     DateTime @updatedAt           // تاريخ آخر تحديث

  // ====== العلاقات ======
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  products Product[] // كل المنتجات التي يبيعها هذا البائع

  // ====== الفهارس ======
  @@index([slug])    // للبحث السريع عن المتجر بالـ slug
  @@index([userId])
  @@map("vendors")
}

// ============================================================================
// القسم الثالث: المنتجات الأساسية
// ============================================================================

// ============================
// تصنيفات المنتجات
// ============================
enum ProductCategory {
  THEME      // قوالب ووردبريس
  PLUGIN     // إضافات
  GRAPHIC    // تصاميم جرافيكية
  JS_MOBILE  // تطبيقات JavaScript للموبايل
  JS_WEB     // تطبيقات JavaScript للويب
  PHP        // سكريبتات PHP
  WORDPRESS  // منتجات ووردبريس عامة
  HTML       // قوالب HTML
  OTHER      // أخرى
}

// ============================
// حالات المنتج
// ============================
enum ProductStatus {
  DRAFT      // مسودة (غير منشور)
  PUBLISHED  // منشور ومتاح للبيع
  ARCHIVED   // مؤرشف (غير متاح)
}

// ============================
// جدول المنتجات الرئيسي
// ============================
model Product {
  // ====== المعلومات الأساسية ======
  id               String          @id @default(cuid())
  vendorId         String                                // معرّف البائع
  title            String                                // عنوان المنتج
  slug             String          @unique               // معرّف فريد للرابط
  price            Decimal         @db.Decimal(10, 2)    // السعر (دقة عشرية: 10 أرقام، 2 بعد الفاصلة)
  currency         String          @default("USD")       // العملة (افتراضياً: دولار أمريكي)
  
  // ====== الإحصائيات ======
  salesCount       Int             @default(0)           // عدد المبيعات
  averageRating    Decimal         @default(0) @db.Decimal(3, 2)  // متوسط التقييم (من 0.00 إلى 5.00)
  
  // ====== الأوصاف ======
  shortDescription String?         @db.Text              // وصف مختصر
  longDescription  String?         @db.Text              // وصف تفصيلي
  thumbnailUrl     String?                               // صورة مصغرة رئيسية
  
  // ====== المواصفات التقنية ======
  isHighResolution Boolean         @default(false)       // هل المنتج بدقة عالية؟
  isWidgetReady    Boolean         @default(false)       // هل يدعم الـ Widgets؟
  layout           String?                               // نوع التخطيط: "Responsive", "Fixed"
  fileSize         String?                               // حجم الملف: "25.3 MB"
  framework        String?                               // إطار العمل: "Underscores", "Custom"
  
  // ====== التصنيف ======
  category         ProductCategory @default(THEME)       // التصنيف الرئيسي
  subcategory      String?                               // تصنيف فرعي (اختياري)
  status           ProductStatus   @default(DRAFT)       // حالة المنتج
  
  // ====== التواريخ ======
  publishedAt      DateTime?                             // تاريخ النشر (null إذا لم يُنشر بعد)
  lastUpdate       DateTime        @default(now())       // تاريخ آخر تحديث للمنتج
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // ====== العلاقات مع الجداول الأخرى ======
  vendor                   Vendor                    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  reviews                  Review[]                  // التقييمات
  productTags              ProductTag[]              // الوسوم (tags)
  productCompatibles       ProductCompatible[]       // التوافقات (Elementor, WooCommerce, etc.)
  productSoftwareVersions  ProductSoftwareVersion[]  // إصدارات البرمجيات المدعومة
  productBrowsers          ProductBrowser[]          // المتصفحات المدعومة
  productFeatures          ProductFeature[]          // الميزات
  productFiles             ProductFile[]             // الملفات القابلة للتحميل
  productImages            ProductImage[]            // معرض الصور
  purchases                Purchase[]                // سجل المشتريات

  // ====== الفهارس ======
  @@index([vendorId])       // للبحث عن منتجات بائع معين
  @@index([slug])           // للوصول السريع للمنتج عبر الرابط
  @@index([category])       // للتصفية حسب التصنيف
  @@index([status])         // لعرض المنتجات المنشورة فقط
  @@index([publishedAt])    // لترتيب المنتجات حسب تاريخ النشر
  @@map("products")
}

// ============================
// جدول ملفات المنتج
// ============================
// يحتوي على الملفات القابلة للتحميل (ZIP, PDF, etc.)
model ProductFile {
  id            String   @id @default(cuid())
  productId     String                           // معرّف المنتج
  fileName      String                           // اسم الملف
  fileUrl       String                           // رابط التحميل
  fileType      String                           // نوع الملف: "zip", "pdf"
  fileSizeBytes BigInt                           // حجم الملف بالبايت
  version       String?                          // رقم الإصدار (اختياري)
  uploadedAt    DateTime @default(now())         // تاريخ الرفع

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_files")
}

// ============================
// جدول صور المنتج
// ============================
// معرض الصور (screenshots, previews)
model ProductImage {
  id           String   @id @default(cuid())
  productId    String
  imageUrl     String                            // رابط الصورة
  displayOrder Int      @default(0)              // ترتيب العرض
  isPreview    Boolean  @default(false)          // هل هذه صورة معاينة رئيسية؟
  uploadedAt   DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

// ============================================================================
// القسم الرابع: خصائص المنتج (Many-to-Many Relationships)
// ============================================================================
// هذا القسم يسمح بإضافة خصائص متعددة لكل منتج بطريقة مرنة

// ============================
// الوسوم (Tags)
// ============================
// أمثلة: "saas", "wordpress", "responsive", "ecommerce"
model Tag {
  id         String   @id @default(cuid())
  name       String   @unique                    // اسم الوسم (فريد)
  slug       String   @unique                    // معرّف للرابط
  usageCount Int      @default(0)               // عدد المنتجات المستخدمة لهذا الوسم
  createdAt  DateTime @default(now())

  productTags ProductTag[]  // العلاقة مع المنتجات

  @@index([slug])
  @@map("tags")
}

// جدول وسيط لربط المنتجات بالوسوم (Many-to-Many)
model ProductTag {
  id        String   @id @default(cuid())
  productId String
  tagId     String
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([productId, tagId])  // منع تكرار نفس الوسم للمنتج الواحد
  @@index([productId])
  @@index([tagId])
  @@map("product_tags")
}

// ============================
// التوافقات (Compatibility)
// ============================
// أمثلة: "Elementor 3.0", "WooCommerce 6.x", "Contact Form 7"
model Compatible {
  id        String   @id @default(cuid())
  name      String   @unique                    // اسم الأداة/الإضافة
  version   String?                             // الإصدار (اختياري)
  type      String?                             // النوع: "Page Builder", "Plugin", "Framework"
  createdAt DateTime @default(now())

  productCompatibles ProductCompatible[]

  @@map("compatibles")
}

// جدول وسيط لربط المنتجات بالتوافقات
model ProductCompatible {
  id           String   @id @default(cuid())
  productId    String
  compatibleId String
  createdAt    DateTime @default(now())

  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  compatible Compatible @relation(fields: [compatibleId], references: [id], onDelete: Cascade)

  @@unique([productId, compatibleId])
  @@index([productId])
  @@index([compatibleId])
  @@map("product_compatibles")
}

// ============================
// إصدارات البرمجيات
// ============================
// أمثلة: "WordPress 6.0", "PHP 8.0", "MySQL 8.0"
model SoftwareVersion {
  id          String    @id @default(cuid())
  software    String                           // اسم البرنامج: "WordPress", "PHP"
  version     String                           // رقم الإصدار: "6.0", "8.0"
  releaseDate DateTime?                        // تاريخ إصدار هذا الإصدار (اختياري)
  createdAt   DateTime  @default(now())

  productSoftwareVersions ProductSoftwareVersion[]

  @@unique([software, version])  // منع تكرار نفس الإصدار
  @@map("software_versions")
}

// جدول وسيط لربط المنتجات بإصدارات البرمجيات
model ProductSoftwareVersion {
  id                String   @id @default(cuid())
  productId         String
  softwareVersionId String
  createdAt         DateTime @default(now())

  product         Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  softwareVersion SoftwareVersion @relation(fields: [softwareVersionId], references: [id], onDelete: Cascade)

  @@unique([productId, softwareVersionId])
  @@index([productId])
  @@index([softwareVersionId])
  @@map("product_software_versions")
}

// ============================
// المتصفحات المدعومة
// ============================
// أمثلة: "Firefox", "Chrome 90+", "Safari", "Edge"
model Browser {
  id         String   @id @default(cuid())
  name       String   @unique                   // اسم المتصفح
  minVersion String?                            // الحد الأدنى من الإصدار (اختياري)
  createdAt  DateTime @default(now())

  productBrowsers ProductBrowser[]

  @@map("browsers")
}

// جدول وسيط لربط المنتجات بالمتصفحات
model ProductBrowser {
  id        String   @id @default(cuid())
  productId String
  browserId String
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  browser Browser @relation(fields: [browserId], references: [id], onDelete: Cascade)

  @@unique([productId, browserId])
  @@index([productId])
  @@index([browserId])
  @@map("product_browsers")
}

// ============================
// الميزات (Features)
// ============================
// أمثلة: "One Click Demo Import", "SEO Optimized", "RTL Support"
model Feature {
  id          String   @id @default(cuid())
  name        String   @unique                  // اسم الميزة
  description String?  @db.Text                 // وصف الميزة
  category    String?                           // تصنيف: "Performance", "SEO", "UX"
  createdAt   DateTime @default(now())

  productFeatures ProductFeature[]

  @@map("features")
}

// جدول وسيط لربط المنتجات بالميزات
model ProductFeature {
  id        String   @id @default(cuid())
  productId String
  featureId String
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  feature Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([productId, featureId])
  @@index([productId])
  @@index([featureId])
  @@map("product_features")
}

// ============================================================================
// القسم الخامس: التقييمات والمراجعات
// ============================================================================

// ============================
// جدول التقييمات
// ============================
model Review {
  id                 String   @id @default(cuid())
  userId             String                      // المستخدم الذي كتب التقييم
  productId          String                      // المنتج المُقيّم
  rating             Int                         // التقييم من 1 إلى 5
  comment            String?  @db.Text           // تعليق نصي (اختياري)
  isVerifiedPurchase Boolean  @default(false)    // هل هذا مشتري حقيقي؟
  helpfulCount       Int      @default(0)        // عدد الأشخاص الذين وجدوا التقييم مفيداً
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt         // يسمح بتعديل التقييم

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId])     // للبحث عن كل تقييمات مستخدم معين
  @@index([productId])  // للبحث عن كل تقييمات منتج معين
  @@index([rating])     // للتصفية حسب التقييم
  @@map("reviews")
}

// ============================================================================
// القسم السادس: المعاملات والمشتريات
// ============================================================================

// ============================
// حالات الشراء
// ============================
enum PurchaseStatus {
  PENDING   // قيد الانتظار (لم تكتمل الدفعة)
  COMPLETED // مكتملة (تمت الدفعة بنجاح)
  REFUNDED  // مُسترَدة (تم استرجاع المبلغ)
  FAILED    // فشلت (خطأ في الدفع)
}

// ============================
// جدول المشتريات
// ============================
model Purchase {
  id            String         @id @default(cuid())
  userId        String                              // المشتري
  productId     String                              // المنتج المشترى
  amount        Decimal        @db.Decimal(10, 2)   // المبلغ المدفوع
  currency      String         @default("USD")      // العملة
  status        PurchaseStatus @default(PENDING)    // حالة الشراء
  paymentMethod String?                             // طريقة الدفع: "stripe", "paypal"
  transactionId String?        @unique              // معرّف المعاملة من بوابة الدفع
  purchasedAt   DateTime       @default(now())      // تاريخ الشراء
  refundedAt    DateTime?                           // تاريخ الاسترجاع (إن وُجد)
  updatedAt     DateTime       @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId])       // لعرض سجل مشتريات المستخدم
  @@index([productId])    // لعرض سجل مبيعات المنتج
  @@index([status])       // للتصفية حسب الحالة
  @@index([purchasedAt])  // لترتيب المشتريات حسب التاريخ
  @@map("purchases")
}

// ============================================================================
// ملاحظات مهمة للمطورين:
// ============================================================================
// 
// 1. العلاقات:
//    - One-to-Many: User -> Reviews (مستخدم واحد له عدة تقييمات)
//    - Many-to-Many: Product <-> Tags (منتج له عدة وسوم، والوسم يُستخدم في عدة منتجات)
//    - One-to-One: User <-> Vendor (مستخدم واحد له متجر واحد فقط)
//
// 2. الحذف المتسلسل (Cascade Delete):
//    - عند حذف مستخدم، تُحذف كل بياناته (حسابات، جلسات، تقييمات، مشتريات)
//    - عند حذف منتج، تُحذف كل الملفات والصور والعلاقات المرتبطة به
//
// 3. الفهارس (Indexes):
//    - مضافة على الحقول كثيرة الاستخدام في البحث والتصفية
//    - تُحسّن الأداء بشكل كبير في قواعد البيانات الكبيرة
//
// 4. القيود الفريدة (Unique Constraints):
//    - تمنع تكرار البيانات (مثل: نفس البريد الإلكتروني مرتين)
//    - مهمة للحفاظ على سلامة البيانات
//
// 5. الحقول الاختيارية (Optional Fields):
//    - المحددة بـ ؟ (String?) يمكن أن تكون null
//    - مفيدة للبيانات غير الضرورية
//
// ============================================================================